<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>typing</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    /* 省略：基本のスタイルは従来と同じ */

    /* 通知ポップアップを数秒で消すために追加も可能だが、今回はJS側で制御 */
  </style>
</head>
<body>
  <div id="app">
    <h1>typing</h1>

    <!-- 左上の設定アイコンや時間設定UIは従来通り -->

    <div id="wordArea">
      <div id="currentWord"></div>
      <div id="inputArea">
        <input type="text" id="userInput" disabled />
        <button id="submitBtn" disabled>Send</button>
      </div>
    </div>

    <!-- 結果表示エリア -->
    <div id="resultArea">
      <h2>Result</h2>
      <p id="sessionCountText">This is Session #: 0</p>
      <!-- 以下、セッションの各項目 -->
      <p id="startTimeText">Session start: -</p>
      <p id="endTimeText">Session end: -</p>
      <p id="notifTimesText">Notifications: (none)</p>
      <p id="score">Correct: 0</p>
      <p id="miss">Wrong: 0</p>
      <p id="typedCount">Typed words: 0</p>
      <p id="typedChars">Typed chars: 0</p>

      <!-- 「Try again」ボタン：リロードしない -->
      <button id="tryAgainBtn">Try again</button>

      <!-- 全セッションまとめてDL -->
      <button id="downloadAllBtn">Download All Results</button>
    </div>
  </div>

  <!-- 通知ポップアップ -->
  <div id="notificationPopup">
    <span id="notifText">Notification</span>
  </div>

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <script>
  /****************************************
   * 1. 通知ポップアップを5秒で自動クローズ
   ****************************************/
  const notificationPopup = document.getElementById('notificationPopup');
  const notifTextElem     = document.getElementById('notifText');
  let popupTimer = null;

  // 通知が来たら表示し、5秒後に自動で閉じる
  const socket = io();
  socket.on('notify', (data) => {
    // 表示内容
    notifTextElem.textContent = data && data.message
      ? data.message
      : 'Please tell me your emotion.';
    notificationPopup.style.display = 'block';

    // 音再生など省略（pick.mp3 のまま）

    // もし既にタイマーが動いていればクリア
    if (popupTimer) clearTimeout(popupTimer);

    // 5秒後に自動で消す
    popupTimer = setTimeout(() => {
      notificationPopup.style.display = 'none';
    }, 5000);  // 5秒 = 5000ms
  });

  /****************************************
   * 2. セッションの履歴を配列に保持
   ****************************************/
  let sessionCount = 0;
  let allSessions  = [];  // 過去セッションの履歴を格納

  // 各セッション結果の変数（例）
  let sessionStartTime = null;
  let sessionEndTime   = null;
  let notifications    = [];
  let correctCount = 0, missCount = 0;
  let totalTyped = 0, totalChars = 0;

  // 終了時に結果をallSessionsにpush
  function endSession() {
    sessionCount++;

    // ...途中省略: sessionEndTime = new Date() 等
    // collect result in an object
    const resultObj = {
      sessionNum: sessionCount,
      startTime: sessionStartTime,
      endTime: sessionEndTime,
      notifications: [...notifications],
      correct: correctCount,
      wrong: missCount,
      typedWords: totalTyped,
      typedChars: totalChars
    };
    // push to array
    allSessions.push(resultObj);

    // UI更新 "This is Session #: X"
    document.getElementById('sessionCountText').textContent
      = `This is Session #: ${sessionCount}`;
    
    // startTime, endTime, notifications, score, miss...など表示
    // ...
    // resultAreaを表示
    document.getElementById('resultArea').style.display = 'block';
  }

  /****************************************
   * 3. Try again ボタンで新セッション開始
   ****************************************/
  const tryAgainBtn = document.getElementById('tryAgainBtn');
  tryAgainBtn.addEventListener('click', () => {
    // resultAreaを一旦隠す or 項目をリセット
    document.getElementById('resultArea').style.display = 'none';

    // ただし過去セッションは allSessions に残しておく
    // 次のセッションで使う変数を初期化し、スペースキーで開始...など
    correctCount = 0;
    missCount   = 0;
    totalTyped  = 0;
    totalChars  = 0;
    notifications = [];
    // 連続セッション向け: set remainingTime = sessionTime; isStarted = false; etc.
    // 画面上の "Press SPACE key to start." はお好みで再表示

    // ここで startTask() を呼ぶか、または
    // ユーザーが再度スペースキーを押す流れにする
  });

  /****************************************
   * 4. 複数セッションまとめてDL
   ****************************************/
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  downloadAllBtn.addEventListener('click', () => {
    // CSVヘッダ行
    const header = [
      'SessionNum', 'StartTime', 'EndTime', 'Notifications',
      'Correct', 'Wrong', 'TypedWords', 'TypedChars'
    ];
    const rows = [header];

    // allSessionsに保存された全セッションを1行ずつに
    allSessions.forEach(session => {
      const notifyStr = session.notifications.length > 0
        ? session.notifications.join(' / ')
        : '';
      rows.push([
        session.sessionNum,
        session.startTime ? session.startTime.toLocaleString() : '',
        session.endTime   ? session.endTime.toLocaleString()   : '',
        notifyStr,
        session.correct,
        session.wrong,
        session.typedWords,
        session.typedChars
      ]);
    });

    // CSV文字列生成
    const csvContent = "data:text/csv;charset=utf-8,"
      + rows.map(r => r.join(",")).join("\n");

    // ダウンロード用リンク生成
    const encodedUri = encodeURI(csvContent);
    const link       = document.createElement("a");

    // ファイル名: allSessions_YYYYMMDD_HHMMSS.csv
    const now = new Date();
    const y = now.getFullYear(); 
    const m = String(now.getMonth()+1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    const hh = String(now.getHours()).padStart(2, "0");
    const mm = String(now.getMinutes()).padStart(2, "0");
    const ss = String(now.getSeconds()).padStart(2, "0");
    link.setAttribute("download", `allSessions_${y}${m}${d}_${hh}${mm}${ss}.csv`);
    link.setAttribute("href", encodedUri);

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // ...以下、残りのロジックは従来通り
  // startTask() や checkAnswer() など
  </script>
</body>
</html>
